<!DOCTYPE html>
<html>

  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="description" content="Pull-request-notifier-for-bitbucket : Stash plugin that invokes a custom URL when a pull request event is triggered.">

    <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/stylesheet.css">

    <title>Pull-request-notifier-for-bitbucket</title>
  </head>

  <body>

    <!-- HEADER -->
    <div id="header_wrap" class="outer">
        <header class="inner">
          <a id="forkme_banner" href="https://github.com/tomasbjerre/pull-request-notifier-for-bitbucket">View on GitHub</a>

          <h1 id="project_title">Pull-request-notifier-for-bitbucket</h1>
          <h2 id="project_tagline">Stash plugin that invokes a custom URL when a pull request event is triggered.</h2>

            <section id="downloads">
              <a class="zip_download_link" href="https://github.com/tomasbjerre/pull-request-notifier-for-bitbucket/zipball/master">Download this project as a .zip file</a>
              <a class="tar_download_link" href="https://github.com/tomasbjerre/pull-request-notifier-for-bitbucket/tarball/master">Download this project as a tar.gz file</a>
            </section>
        </header>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="outer">
      <section id="main_content" class="inner">
        <h1>
<a id="pull-request-notifier-for-bitbucket-" class="anchor" href="#pull-request-notifier-for-bitbucket-" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Pull Request Notifier for Bitbucket <a href="https://travis-ci.org/tomasbjerre/pull-request-notifier-for-bitbucket"><img src="https://travis-ci.org/tomasbjerre/pull-request-notifier-for-bitbucket.svg?branch=master" alt="Build Status"></a>
</h1>

<p>The original use case was to trigger Jenkins jobs to build pull requests that are created in Bitbucket. The plugin can be configured to trigger different Jenkins jobs for different repositories. It can supply custom parameters to the jenkins job using the variables. It can authenticate with HTTP Basic.</p>

<p>It can, for example, trigger a build in Jenkins. Parameterized Jenkins jobs can be triggered remotely via:</p>

<pre><code>http://server/job/theJob/buildWithParameters?token=TOKEN&amp;PARAMETER=Value
</code></pre>

<p>The plugin can trigger any system, not only Jenkins. The plugin can notify any system that can be notified with a URL.</p>

<p><a href="https://raw.githubusercontent.com/tomasbjerre/pull-request-notifier-for-bitbucket/master/sandbox/all.png">Here</a> is a screenshot of the admin GUI on global level. And <a href="https://raw.githubusercontent.com/tomasbjerre/pull-request-notifier-for-bitbucket/master/sandbox/repo.png">here</a> is a screenshot of the admin GUI on repository level.</p>

<p><a href="http://bjurr.se/building-atlassian-stash-pull-requests-in-jenkins/">Here</a> is a blog post that includes the plugin.</p>

<p>Available in <a href="https://marketplace.atlassian.com/plugins/se.bjurr.prnfs.pull-request-notifier-for-stash">Atlassian Marketplace</a>.</p>

<h2>
<a id="features" class="anchor" href="#features" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Features</h2>

<p>The Pull Request Notifier for Bitbucket can:</p>

<ul>
<li>Invoke any URL, or set of URL:s, when a pull request event happens.

<ul>
<li>With variables available to add necessary parameters.</li>
<li>HTTP POST, PUT, GET and DELETE. POST and PUT also supports rendered post content. </li>
</ul>
</li>
<li>Be configured to trigger on any <a href="https://developer.atlassian.com/static/javadoc/stash.old-perms-pre-feb4/2.0.1/api/reference/com/atlassian/stash/event/pull/package-summary.html">pull request event</a>. Including extended events:

<ul>
<li>RESCOPED_FROM, when source branch change</li>
<li>RESCOPED_TO, when target branch change</li>
<li>BUTTON_TRIGGER, when trigger button in pull request view is pressed</li>
</ul>
</li>
<li>Can invoke CSRF protected systems, using the ${INJECTION_URL_VALUE} variable. How to to that with Jenkins is described below.</li>
<li>Be configured to only trigger if the pull request mathches a filter. A filter text is constructed with any combination of the variables and then a regexp is constructed to match that text.</li>
<li>Add buttons to pull request view in Bitbucket. And map those buttons to URL invocations. This can be done by setting the filter string to ${BUTTON_TRIGGER_TITLE} and the filter regexp to title of button.</li>
<li>Authenticate with HTTP basic authentication.</li>
<li>Optionally allow any SSL certificate.</li>
<li>Use custom SSL key store, type and password.</li>
<li>Send custom HTTP headers</li>
<li>Can optionally use proxy to connect</li>
<li>Can let users and/or admins do configuration. Or restrict configuration to just system admins. A user will have to browse to the configuration page at <code>http://domain/bitbucket/plugins/servlet/prnfb/admin</code>.</li>
<li>Can enable trigger

<ul>
<li>If PR has, or has no, conflicts</li>
<li>Only if PR has conflicts</li>
<li>Only if PR has no conflicts</li>
</ul>
</li>
<li>Nice configuration GUI.

<ul>
<li>Global at <em>/bitbucket/plugins/servlet/prnfb/admin</em>
</li>
<li>Repo level at <em>/bitbucket/plugins/servlet/prnfb/admin/PROJECT_1/rep_1</em>
</li>
</ul>
</li>
</ul>

<p>The plugin has its own implementation to create the RESCOPED_FROM and RESCOPED_TO events. RESCOPED is transformed to RESCOPED_TO if target branch changed, RESCOPED_FROM if source branch, or both, changed.</p>

<p>The filter text as well as the URL support variables. These are:</p>

<ul>
<li>${EVERYTHING_URL} Example: PULL_REQUEST_ID=1&amp;PULL_REQUEST_TITLE=some%20thing...</li>
<li>${PULL_REQUEST_ID} Example: 1</li>
<li>${PULL_REQUEST_TITLE} Example: Anything</li>
<li>${PULL_REQUEST_VERSION} Example: 1</li>
<li>${PULL_REQUEST_COMMENT_TEXT} Example: A comment</li>
<li>${PULL_REQUEST_ACTION} Example: OPENED</li>
<li>${PULL_REQUEST_STATE} Example: DECLINED, MERGED, OPEN</li>
<li>${BUTTON_TRIGGER_TITLE} Example: Trigger Notification</li>
<li>${INJECTION_URL_VALUE} Value retrieved from any URL</li>
<li>${PULL_REQUEST_URL} Example: http://localhost:7990/projects/PROJECT_1/repos/rep_1/pull-requests/1</li>
<li>${PULL_REQUEST_USER_DISPLAY_NAME} Example: Some User</li>
<li>${PULL_REQUEST_USER_EMAIL_ADDRESS} Example: <a href="mailto:some.user@bitbucket.domain">some.user@bitbucket.domain</a>
</li>
<li>${PULL_REQUEST_USER_ID} Example: 1</li>
<li>${PULL_REQUEST_USER_NAME} Example: user.name</li>
<li>${PULL_REQUEST_USER_SLUG} Example: user.name</li>
<li>${PULL_REQUEST_AUTHOR_DISPLAY_NAME} Example: Administrator</li>
<li>${PULL_REQUEST_AUTHOR_EMAIL} Example: <a href="mailto:admin@example.com">admin@example.com</a>
</li>
<li>${PULL_REQUEST_AUTHOR_ID} Example: 1</li>
<li>${PULL_REQUEST_AUTHOR_NAME} Example: admin</li>
<li>${PULL_REQUEST_AUTHOR_SLUG} Example: admin</li>
<li>${PULL_REQUEST_REVIEWERS} Example: Administrator,User</li>
<li>${PULL_REQUEST_REVIEWERS_ID} Example: 1,2</li>
<li>${PULL_REQUEST_REVIEWERS_SLUG} Example: admin,user</li>
<li>${PULL_REQUEST_REVIEWERS_APPROVED_COUNT} Number of reviewers that approved the PR.</li>
<li>${PULL_REQUEST_PARTICIPANTS_APPROVED_COUNT} Number of participants that approved the PR.</li>
<li>${PULL_REQUEST_MERGE_COMMIT} Hash of merged commit (only available for merged-event).</li>
<li>${PULL_REQUEST_FROM_SSH_CLONE_URL} Example: ssh://git@localhost:7999/project_1/rep_1</li>
<li>${PULL_REQUEST_FROM_HTTP_CLONE_URL} Example: http://admin@localhost:7990/bitbucket/scm/project_1/rep_1.git</li>
<li>${PULL_REQUEST_FROM_HASH} Example: 6053a1eaa1c009dd11092d09a72f3c41af1b59ad</li>
<li>${PULL_REQUEST_FROM_ID} Example: refs/heads/branchmodmerge</li>
<li>${PULL_REQUEST_FROM_BRANCH} Example: branchmodmerge</li>
<li>${PULL_REQUEST_FROM_REPO_ID} Example: 1</li>
<li>${PULL_REQUEST_FROM_REPO_NAME} Example: rep_1</li>
<li>${PULL_REQUEST_FROM_REPO_PROJECT_ID} Example: 1</li>
<li>${PULL_REQUEST_FROM_REPO_PROJECT_KEY} Example: PROJECT_1</li>
<li>${PULL_REQUEST_FROM_REPO_SLUG} Example: rep_1</li>
<li>${PULL_REQUEST_TO_SSH_CLONE_URL} Example: ssh://git@localhost:7999/project_1/rep_1</li>
<li>${PULL_REQUEST_TO_HTTP_CLONE_URL} Example: http://admin@localhost:7990/bitbucket/scm/project_1/rep_1.git</li>
<li>${PULL_REQUEST_TO_HASH} Example: 6053a1eaa1c009dd11092d09a72f3c41af1b59ad</li>
<li>${PULL_REQUEST_TO_ID} Example: refs/heads/branchmodmerge</li>
<li>${PULL_REQUEST_TO_BRANCH} Example: branchmodmerge</li>
<li>${PULL_REQUEST_TO_REPO_ID} Example: 1</li>
<li>${PULL_REQUEST_TO_REPO_NAME} Example: rep_1</li>
<li>${PULL_REQUEST_TO_REPO_PROJECT_ID} Example: 1</li>
<li>${PULL_REQUEST_TO_REPO_PROJECT_KEY} Example: PROJECT_1</li>
<li>${PULL_REQUEST_TO_REPO_SLUG} Example: rep_1</li>
</ul>

<p>The ${PULL_REQUEST_USER...} contains information about the user who issued the event. Who commented it, who rejected it, who approved it...</p>

<p>You may want to use <a href="https://wiki.jenkins-ci.org/display/JENKINS/Violation+Comments+to+Stash+Plugin">Violation Comments to Stash plugin</a> and/or <a href="https://wiki.jenkins-ci.org/display/JENKINS/StashNotifier+Plugin">StashNotifier plugin</a> to report results back to Bitbucket.</p>

<h3>
<a id="rest" class="anchor" href="#rest" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>REST</h3>

<p>Some rest resources are available. You can figure out the JSON structure by looking at the <a href="https://github.com/tomasbjerre/pull-request-notifier-for-bitbucket/tree/master/src/main/java/se/bjurr/prnfb/presentation/dto">DTO:s</a>.</p>

<ul>
<li>
<p><code>/bitbucket/rest/prnfb-admin/1.0/settings</code></p>

<ul>
<li>
<code>GET</code> Get all global settings.</li>
<li>
<code>POST</code> Store all global settings.</li>
</ul>
</li>
<li>
<p><code>/bitbucket/rest/prnfb-admin/1.0/settings/notifications</code></p>

<ul>
<li>
<code>DELETE /{uuid}</code> Deletes notification with <em>uuid</em>.</li>
<li>
<code>GET</code> Get all notifications.</li>
<li>
<code>GET /{uuid}</code> Get notification with <em>uuid</em>.</li>
<li>
<code>GET /projectKey/{projectKey}</code> Get all notifications for the project.</li>
<li>
<code>GET /projectKey/{projectKey}/repositorySlug/{repositorySlug}</code> Get all notifications for the project and repository.</li>
<li>
<code>POST</code> Save a notification.</li>
</ul>
</li>
<li>
<p><code>/bitbucket/rest/prnfb-admin/1.0/settings/buttons</code></p>

<ul>
<li>
<code>DELETE /{uuid}</code> Deletes button with <em>uuid</em>.</li>
<li>
<code>GET</code> Get all buttons that the current user is allowed to use.</li>
<li>
<code>GET /{uuid}</code> Get button with <em>uuid</em>.</li>
<li>
<code>GET /repository/{repositoryId}/pullrequest/{pullRequestId}</code> Get all buttons for repository that the current user is allowed to use.</li>
<li>
<code>GET /projectKey/{projectKey}</code> Get all buttons for the project.</li>
<li>
<code>GET /projectKey/{projectKey}/repositorySlug/{repositorySlug}</code> Get all buttons for the project and repository.</li>
<li>
<code>POST</code> Save a button.</li>
<li>
<code>POST {uuid}/press/repository/{repositoryId}/pullrequest/{pullRequestId}</code> Press the button.</li>
</ul>
</li>
</ul>

<p>A new notification to trigger on <em>COMMENTED</em> can be added like this.</p>

<pre><code>curl -u admin:admin 'http://localhost:7990/bitbucket/rest/prnfb-admin/1.0/settings/notifications' -H 'Content-Type: application/json; charset=UTF-8' -H 'Accept: application/json, text/javascript, */*; q=0.01' --data-binary '{"uuid":"","name":"","projectKey":"","repositorySlug":"","filterString":"","filterRegexp":"","triggers":["COMMENTED"],"injectionUrl":"","injectionUrlRegexp":"","user":"","password":"","proxyUser":"","proxyPassword":"","proxyServer":"","proxyPort":"","url":"http://localhost:80/?abc","method":"GET","postContent":"","headers":[{"name":"","value":""}]}'
</code></pre>

<p>It will respond with something like this.</p>

<pre><code>{"headers":[],"method":"GET","name":"Notification","triggerIfCanMerge":"ALWAYS","triggerIgnoreStateList":[],"triggers":["COMMENTED"],"url":"http://localhost:80/?abc","uuid":"b1306a3a-5a87-4145-80b7-660bc986dd25"}
</code></pre>

<p>It can then be changed to trigger on <em>RESCOPED_FROM</em> and <em>RESCOPED_TO</em> like this.</p>

<pre><code>curl -u admin:admin 'http://localhost:7990/bitbucket/rest/prnfb-admin/1.0/settings/notifications' -H 'Content-Type: application/json; charset=UTF-8' -H 'Accept: application/json, text/javascript, */*; q=0.01' --data-binary '{"uuid":"b1306a3a-5a87-4145-80b7-660bc986dd25","name":"Notification","projectKey":"","repositorySlug":"","filterString":"","filterRegexp":"","triggerIfCanMerge":"ALWAYS","triggers":["RESCOPED_FROM","RESCOPED_TO"],"injectionUrl":"","injectionUrlRegexp":"","user":"","password":"","proxyUser":"","proxyPassword":"","proxyServer":"","proxyPort":"","url":"http://localhost:80/?abc","method":"GET","postContent":"","headers":[{"name":"","value":""}]}' --compressed
</code></pre>

<p>It will respond with something like this.</p>

<pre><code>{"headers":[],"method":"GET","name":"Notification","triggerIfCanMerge":"ALWAYS","triggerIgnoreStateList":[],"triggers":["RESCOPED_FROM","RESCOPED_TO"],"url":"http://localhost:80/?abc","uuid":"b1306a3a-5a87-4145-80b7-660bc986dd25"}
</code></pre>

<p>You may use Chrome and Developer Tools (press F12) to view rest calls while editing in GUI to find more examples.</p>

<h3>
<a id="jenkins" class="anchor" href="#jenkins" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Jenkins</h3>

<p>Parameterized Jenkins jobs can be triggered remotely by invoking a URL. How you trigger your Jennkins installation may vary depending on how it is configured. Here is, probably, the most complicated scenario where there is CSRF protection and authentication requirements.</p>

<p>The job that you want to trigger must have:</p>

<ul>
<li>
<em>This build is parameterized</em> checkbox checked.</li>
<li>
<em>Trigger builds remotely</em> checkbox checked.

<ul>
<li>You may, or may not, use a token here.</li>
</ul>
</li>
</ul>

<p>I like to add an <em>Execute shell</em> build step and then just do <code>echo param: $paramName</code> to test that my parameter shows up in the build job log.</p>

<p>First, you may try to trigger Jenkins with <a href="https://github.com/curl/curl">Curl</a> from command line and then, when you know how it should be done, configure the plugin.</p>

<p>If your Jenkins is CSRF protected, you need to get a crumb. It can be done like this.</p>

<pre><code>curl -s 'http://JENKINS_HOSTNAME/crumbIssuer/api/xml?xpath=concat(//crumbRequestField,":",//crumb)'
</code></pre>

<p>The response should be something like <code>Jenkins-Crumb:f122c77298b349b0116140265418ec7f</code>.</p>

<p>Now you can trigger a build like this (just remove <code>?token=YOUR_TOKEN</code> if you are not using a token).</p>

<pre><code>curl -u USERNAME:PASSWORD -X POST --data "paramName=paramValue" -H "Jenkins-Crumb:f122c77298b349b0116140265418ec7f" http://JENKINS_HOSTNAME/job/JENKINS_JOB/buildWithParameters?token=YOUR_TOKEN
</code></pre>

<p>Now that job should have been triggered and you should be able to verify that Jenkins is setup correclty. You may want to SSH to the Bitbucket Server machine and do this, to also verify that firewalls are open.</p>

<p>Now to configure the plugin!</p>

<p>If you need <strong><em>authentication</em></strong>, add your username and password in <em>Basic authentication</em>.</p>

<p>If you are using a <strong><em>CSRF</em></strong> protection in Jenkins, you can use the <strong>Injection URL</strong> feature.</p>

<ul>
<li>Set <strong>Injection URL</strong> field to <code>http://JENKINS_HOSTNAME/crumbIssuer/api/xml?xpath=//crumb/text()</code>.

<ul>
<li>You may get an error like <em>primitive XPath result sets forbidden; implement jenkins.security.SecureRequester</em>. If so, you can set Injection URL to <code>http://JENKINS/crumbIssuer/api/xml?xpath=//crumb</code> in combination with regular expression <code>&lt;crumb&gt;([^&lt;]*)&lt;/crumb&gt;</code>.</li>
<li>A third option is to checkout <a href="https://wiki.jenkins-ci.org/display/JENKINS/Secure+Requester+Whitelist+Plugin">this</a> Jenkins plugin.</li>
</ul>
</li>
<li>In the headers section, set header <strong>Jenkins-Crumb</strong> with value <strong>${INJECTION_URL_VALUE}</strong>. The <code>Jenkins-Crumb</code> header name was previously just <code>.crumb</code>, use whatever the <code>curl</code> command responded with above.</li>
</ul>

<p>You may trigger the build with <code>GET</code> or <code>POST</code>.</p>

<p>In <strong><em>URL</em></strong> add <code>http://JENKINS_HOSTNAME/job/JENKINS_JOB/buildWithParameters?token=YOUR_TOKEN&amp;paramName=paramValue</code>.</p>

<p>Thats it! There are some common mistakes.</p>

<ul>
<li>If using ${EVERYTHING_URL}, like <code>...?token=token&amp;${EVERYTHING_URL}</code> then in your jenkins job you have to have parameters for each parameter, like <code>PULL_REQUEST_URL</code>.</li>
<li>Even when using <code>POST</code>, you should add the parameters to the <code>URL</code>.</li>
</ul>

<h2>
<a id="reporting-issues" class="anchor" href="#reporting-issues" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Reporting issues</h2>

<p>If things don't work as you expect, perhaps you should file an issue. But first, try troubleshooting it and provide as much info as possible. Here are some things that may help if added to an issue.</p>

<ul>
<li>Plugin version used.</li>
<li>Bitbucket Server version used.</li>
<li>Stack traces in Bitbucket Server log file.</li>
<li>Any browser console log messages, you can find it in Developer Tools in Chome by pressing F12.</li>
<li>Screenshot of plugin configuration in your issue.</li>
<li>
<p>Your configuration.
You can get it with something like this:</p>

<p><code>curl -u admin:admin 'http://localhost:7990/bitbucket/rest/prnfb-admin/1.0/settings' -H 'Accept: application/json, text/javascript, */*; q=0.01'</code></p>

<p><code>curl -u admin:admin 'http://localhost:7990/bitbucket/rest/prnfb-admin/1.0/settings/notifications' -H 'Accept: application/json, text/javascript, */*; q=0.01'</code>.</p>

<p><code>curl -u admin:admin 'http://localhost:7990/bitbucket/rest/prnfb-admin/1.0/settings/buttons' -H 'Accept: application/json, text/javascript, */*; q=0.01'</code>.</p>
</li>
<li>If the system you are trying to notify does not seem to get notified you may check that the triggered URL looks as expected. You can do that by setting up a webserver, let the plugin invoke that with same parameters and then look at its log files to se the requested URL. Or notify <em><a href="http://cogi.bjurr.se/?%24%7B...%7D">http://cogi.bjurr.se/?${...}</a></em> and I can check my logs and tell you what the URL looks like.</li>
</ul>

<h2>
<a id="developer-instructions" class="anchor" href="#developer-instructions" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Developer instructions</h2>

<p>There are some scripts to help working with the plugin.</p>

<ul>
<li>
<code>./setup-atlassian-sdk.sh</code> Setup Atlassian SDK.</li>
<li>
<code>./docker-build.sh</code> Build Docker container.</li>
<li>
<code>./docker-run.sh</code> Run the Docker container.</li>
<li>
<code>./integration-test-local.sh</code> Run integration tests against localhost.</li>
<li>
<code>./integration-test.sh</code> Start Docker container and then runs integration tests against it.</li>
</ul>

<p>The .travis.yml is setting up Atlas SDK and building the plugin. It may help you setup your environment.</p>

<p>Prerequisites:</p>

<ul>
<li>Atlas SDK <a href="https://developer.atlassian.com/docs/getting-started/set-up-the-atlassian-plugin-sdk-and-build-a-project">(installation instructions)</a>.</li>
<li>JDK 1.8 or newer</li>
</ul>

<p>Generate Eclipse project:</p>

<pre><code>atlas-compile eclipse:eclipse
</code></pre>

<p>Package the plugin:</p>

<pre><code>atlas-package
</code></pre>

<p>Run Bitbucket, with the plugin, on localhost:</p>

<pre><code>export MAVEN_OPTS=-Dplugin.resource.directories=`pwd`/src/main/resources
atlas-run
</code></pre>

<p>You can also remote debug on port 5005 with:</p>

<pre><code>atlas-debug
</code></pre>

<p>Make a release <a href="https://developer.atlassian.com/docs/common-coding-tasks/development-cycle/packaging-and-releasing-your-plugin">(detailed instructions)</a>:</p>

<pre><code>mvn -B release:prepare -DperformRelease=true release:perform
</code></pre>
      </section>
    </div>

    <!-- FOOTER  -->
    <div id="footer_wrap" class="outer">
      <footer class="inner">
        <p class="copyright">Pull-request-notifier-for-bitbucket maintained by <a href="https://github.com/tomasbjerre">tomasbjerre</a></p>
        <p>Published with <a href="https://pages.github.com">GitHub Pages</a></p>
      </footer>
    </div>

    

  </body>
</html>
